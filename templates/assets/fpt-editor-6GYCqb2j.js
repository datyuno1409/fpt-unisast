import{u as K,r as a,a as M,j as e}from"./index-DvujZN1e.js";import{F as Q,B as U}from"./index.es-bT6xLkJU.js";import{w as G,d as J}from"./index-BQHB4lmd.js";import{a as X}from"./axios-upsvKRUO.js";import{n as r}from"./index-DcKQiY_O.js";const R={ts:"typescript",tsx:"typescript",js:"javascript",jsx:"javascript",json:"json",html:"html",css:"css",scss:"scss",less:"less",md:"markdown",py:"python",java:"java",cpp:"cpp",c:"c",cs:"csharp",go:"go",rs:"rust",php:"php",sql:"sql",yaml:"yaml",yml:"yaml",xml:"xml",sh:"shell",bash:"shell",txt:"plaintext"},Y=y=>y.endsWith("fpt_scan"),ie=()=>{const y=K(),[d,g]=a.useState(""),[u,k]=a.useState(null),[p,N]=a.useState(""),[b,C]=a.useState("plaintext"),[x,H]=a.useState(null),[I,W]=a.useState([]),[o]=M(),[w,v]=a.useState(!1),[h,j]=a.useState(""),[F,S]=a.useState(!1),[L,A]=a.useState(!1),[B,f]=a.useState(!1),_=t=>{var n;const s=((n=t.split(".").pop())==null?void 0:n.toLowerCase())??"";return R[s]||"plaintext"},O=async()=>{try{const t=await window.showDirectoryPicker({mode:"read",id:"fpt-scan-folder",startIn:"documents"});if(!Y(t.name)){r.error('Vui lòng chỉ chọn folder có tên "fpt_scan"');return}H(t);const s=[],n=async(l,i="")=>{var m;for await(const c of l.values())c.kind==="file"?(((m=c.name.split(".").pop())==null?void 0:m.toLowerCase())??"")in R&&s.push({handle:c,name:c.name,path:`${i}${c.name}`}):c.kind==="directory"&&await n(c,`${i}${c.name}/`)};await n(t),W(s)}catch{r.error("Lỗi khi mở folder. Vui lòng chọn đúng folder được cho phép")}},$=a.useCallback(async t=>{try{const s=t.handle,n=await(await s.getFile()).text();k(s),g(n),N(t.name),C(_(t.name))}catch{r.error("Lỗi khi đọc file")}},[]),E=a.useCallback(async()=>{if(u)try{const t=await u.createWritable();await t.write(d),await t.close(),r.success("Đã lưu file thành công")}catch{r.error("Lỗi khi lưu file")}},[u,d]),q=a.useCallback(t=>{g(t??"")},[]),P=a.useCallback(async()=>{if(u)try{const t=await u.createWritable();await t.write(h),await t.close(),g(h),v(!1),j(""),r.success("Đã áp dụng và lưu sửa đổi"),f(!0)}catch{r.error("Đã áp dụng sửa đổi nhưng không thể lưu file")}},[h,u]),T=a.useCallback(()=>{v(!1),j(""),r.error("Đã hủy sửa đổi")},[]);a.useEffect(()=>{const t=s=>{(s.ctrlKey||s.metaKey)&&s.key==="s"&&(s.preventDefault(),E())};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[u,E]);const D=a.useCallback(t=>{const s=t.replace(/^```\w*\n/,"").replace(/\n```$/,"").trim(),n=o.get("problematic_code");if(n&&d){const l=d.replace(n.trim(),s.trim());j(l),v(!0)}},[d,o]),z=async(t,s)=>{const n=[t];for(;n.length>0;){const l=n.shift();for await(const i of l.values()){if(i.kind==="file"&&i.name===s)return{handle:i,name:i.name,path:i.name};i.kind==="directory"&&n.push(i)}}return null};a.useEffect(()=>{(async()=>{const s=decodeURIComponent(o.get("file")??""),n=decodeURIComponent(o.get("problematic_code")??"");if(x&&s&&n){const l=await z(x,s.split("/").pop()??"");if(l){const i=await(await l.handle.getFile()).text();g(i),k(l.handle),N(l.name),C(_(l.name)),A(!0)}}})()},[x,o]),a.useEffect(()=>{(async()=>{const s=o.get("vulnerability_type"),n=o.get("file"),l=o.get("problematic_code"),i=o.get("vulnerability_description");if(!F&&L&&s&&n&&l&&i)try{S(!0);const m=await X.post("/api/fix",{vulnerability_type:s,file:n,problematic_code:l,vulnerability_description:i});m.data.status==="success"&&m.data.fixed_code?D(m.data.fixed_code):r.error(m.data.message??"Lỗi không xác định")}catch{r.error("Có lỗi xảy ra khi xử lý yêu cầu"),S(!1)}})()},[o,D,F,L]);const V=()=>{f(!1),y("/scan?rescan=true")};return e.jsxs("div",{className:"flex h-screen flex-col",children:[B&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:()=>f(!1)}),e.jsxs("div",{className:"relative z-10 w-full max-w-md rounded-lg bg-white p-6 shadow-xl",children:[e.jsx("h3",{className:"mb-4 text-lg font-medium text-gray-900",children:"Quét lại mã nguồn?"}),e.jsx("p",{className:"mb-6 text-sm text-gray-600",children:"Bạn có muốn quét lại mã nguồn để tìm lỗi bảo mật không?"}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:V,className:"rounded-lg bg-blue-500 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-600",children:"Quét lại"}),e.jsx("button",{onClick:()=>f(!1),className:"rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-200",children:"Bỏ qua"})]})]})]}),x?e.jsxs("div",{className:"flex flex-1 overflow-hidden bg-gradient-to-br from-gray-50 via-gray-50 to-white",children:[e.jsxs("div",{className:"z-20 w-64 shrink-0 overflow-y-auto border-r border-gray-200 bg-white/80 p-4 backdrop-blur-sm",children:[e.jsx("div",{className:"mb-4",children:e.jsx("div",{className:"font-medium text-gray-900",children:"Files:"})}),I.map(t=>e.jsx("div",{onClick:()=>$(t),className:`mb-2 cursor-pointer rounded-lg p-2 transition-all duration-200 hover:bg-gray-100 hover:shadow-sm ${p===t.name?"bg-gray-100 shadow-sm":""}`,children:t.name},t.path))]}),e.jsxs("div",{className:"relative flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between bg-white/80 p-4 shadow-sm backdrop-blur-sm",children:[e.jsx("span",{className:"font-medium text-gray-700",children:w&&h?"Đề xuất sửa lỗi":"Editor"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>f(!0),className:"rounded-lg bg-blue-500 px-4 py-2 text-white transition-all duration-200 hover:bg-blue-600 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2",children:"Quét lại"}),w&&h&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:P,className:"rounded-lg bg-green-500 px-4 py-2 text-white transition-all duration-200 hover:bg-green-600 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2",children:"Chấp nhận"}),e.jsx("button",{onClick:T,className:"rounded-lg bg-red-500 px-4 py-2 text-white transition-all duration-200 hover:bg-red-600 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2",children:"Từ chối"})]})]})]}),w&&h?e.jsx(G,{height:"calc(100% - 64px)",language:b,original:d,modified:h,theme:"github-light",options:{readOnly:!0,renderSideBySide:!0,minimap:{enabled:!1},scrollBeyondLastLine:!1,padding:{top:16}}}):e.jsx(J,{height:"100%",defaultLanguage:b,language:b,value:d,onChange:q,options:{minimap:{enabled:!1},fontSize:14,inlayHints:{enabled:"on"},wordWrap:"on",automaticLayout:!0,scrollBeyondLastLine:!1,readOnly:p.endsWith(".exe")||p.endsWith(".dll")||p.endsWith(".bin"),padding:{top:16}},theme:"github-light",className:"rounded-lg shadow-sm"})]})]}):e.jsxs("div",{className:"flex min-h-screen flex-col items-center justify-center bg-gradient-to-br from-gray-50 via-gray-50 to-white px-8 py-12",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-4xl font-bold text-gray-900",children:"FPT UniSAST - AI Assistant"}),e.jsx("p",{className:"mt-4 text-lg text-gray-600",children:'Chọn folder "Documents/uniast/uploads/fpt_scan"'})]}),e.jsx("div",{className:"mt-12 w-full max-w-2xl",children:e.jsx("div",{onClick:O,className:"group relative cursor-pointer overflow-hidden rounded-xl border-2 border-dashed border-gray-300 bg-white/50 p-12 text-center backdrop-blur-sm transition-all duration-300 hover:border-gray-400 hover:bg-white/80 hover:shadow-lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(Q,{icon:U,className:"h-12 w-12 text-gray-400 transition-transform duration-300 group-hover:scale-110 group-hover:text-gray-500"}),e.jsx("div",{className:"space-y-2",children:e.jsx("p",{className:"text-lg font-medium text-gray-700",children:"Click để mở folder"})})]})})})]})]})};export{ie as default};
